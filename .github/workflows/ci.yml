name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install pre-commit
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pre-commit

      - name: Run pre-commit hooks
        run: |
          pre-commit run --all-files --show-diff-on-failure

  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config clang clang-tidy libgtest-dev

          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Run clang-tidy checks
        env:
          CC: clang
          CXX: clang++
        run: |
          chmod +x ./scripts/run_clang_tidy.sh
          ./scripts/run_clang_tidy.sh --clean --build-dir build-tidy --jobs "$(nproc)"

  build-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [gcc, clang]
        sanitizer: [none, asan, ubsan, tsan]
        exclude:
          - toolchain: gcc
            sanitizer: tsan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config libgtest-dev redis-server
          if [ "${{ matrix.toolchain }}" = "clang" ]; then
            sudo apt-get install -y clang
          else
            sudo apt-get install -y g++
          fi

          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Start local Redis
        run: |
          if ! redis-cli -h 127.0.0.1 -p 6379 ping >/dev/null 2>&1; then
            sudo redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --save "" --appendonly no
          fi
          redis-cli -h 127.0.0.1 -p 6379 ping

      - name: Build and run tests
        env:
          CC: ${{ matrix.toolchain == 'clang' && 'clang' || 'gcc' }}
          CXX: ${{ matrix.toolchain == 'clang' && 'clang++' || 'g++' }}
        run: |
          chmod +x ./scripts/build.sh
          CTEST_TIMEOUT=180
          if [ "${{ matrix.sanitizer }}" = "asan" ]; then
            ./scripts/build.sh -c -t --asan --ctest-timeout "$CTEST_TIMEOUT"
          elif [ "${{ matrix.sanitizer }}" = "ubsan" ]; then
            ./scripts/build.sh -c -t --ubsan --ctest-timeout "$CTEST_TIMEOUT"
          elif [ "${{ matrix.sanitizer }}" = "tsan" ]; then
            ./scripts/build.sh -c -t --tsan --ctest-timeout "$CTEST_TIMEOUT"
          else
            ./scripts/build.sh -c -t --ctest-timeout "$CTEST_TIMEOUT"
          fi

  client-stress-repeat:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++ libgtest-dev redis-server

          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Start local Redis
        run: |
          if ! redis-cli -h 127.0.0.1 -p 6379 ping >/dev/null 2>&1; then
            sudo redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --save "" --appendonly no
          fi
          redis-cli -h 127.0.0.1 -p 6379 ping

      - name: Build tests
        run: |
          cmake -S . -B build-client-stress \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREDISCORO_BUILD_TESTS=ON \
            -DREDISCORO_BUILD_EXAMPLES=OFF
          cmake --build build-client-stress -j "$(nproc)"

      - name: Repeat client tests until fail (20 rounds)
        timeout-minutes: 20
        run: |
          ctest --test-dir build-client-stress --output-on-failure \
            --timeout 180 \
            -j 1 \
            -R '^client_.*' \
            --repeat until-fail:20

  install-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++ redis-server

      - name: Start local Redis
        run: |
          if ! redis-cli -h 127.0.0.1 -p 6379 ping >/dev/null 2>&1; then
            sudo redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --save "" --appendonly no
          fi
          redis-cli -h 127.0.0.1 -p 6379 ping

      - name: Build and install
        run: |
          chmod +x ./scripts/build.sh
          ./scripts/build.sh -c -r
          cmake --install build --prefix "$PWD/_install"

      - name: Build consumer with find_package
        run: |
          mkdir -p /tmp/rediscoro-consumer
          cat > /tmp/rediscoro-consumer/CMakeLists.txt <<'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(rediscoro_consumer LANGUAGES CXX)

          set(CMAKE_CXX_STANDARD 20)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          set(CMAKE_CXX_EXTENSIONS OFF)

          find_package(rediscoro REQUIRED)

          add_executable(consumer main.cpp)
          target_link_libraries(consumer PRIVATE rediscoro::rediscoro)
          EOF

          cat > /tmp/rediscoro-consumer/main.cpp <<'EOF'
          #include <rediscoro/rediscoro.hpp>

          #include <iocoro/iocoro.hpp>

          auto task() -> iocoro::awaitable<void> {
            auto ex = co_await iocoro::this_coro::executor;

            rediscoro::config cfg{};
            cfg.host = "127.0.0.1";
            cfg.port = 6379;
            cfg.reconnection.enabled = false;

            rediscoro::client c{ex, cfg};
            (void)co_await c.connect();
            co_await c.close();
          }

          int main() {
            iocoro::io_context ctx;
            iocoro::co_spawn(ctx.get_executor(), task(), iocoro::detached);
            ctx.run();
            return 0;
          }
          EOF

          cmake -S /tmp/rediscoro-consumer -B /tmp/rediscoro-consumer/build -G Ninja \
            -DCMAKE_PREFIX_PATH="$PWD/_install"
          cmake --build /tmp/rediscoro-consumer/build -j
          /tmp/rediscoro-consumer/build/consumer

  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++ libgtest-dev gcovr python3 redis-server

          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Start local Redis
        run: |
          if ! redis-cli -h 127.0.0.1 -p 6379 ping >/dev/null 2>&1; then
            sudo redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --save "" --appendonly no
          fi
          redis-cli -h 127.0.0.1 -p 6379 ping

      - name: Build, test, and collect coverage
        run: |
          chmod +x ./scripts/run_coverage.sh
          ./scripts/run_coverage.sh --clean --build-dir build-coverage --jobs "$(nproc)" --min-line 60 --min-branch 30 --min-function 75

      - name: Coverage summary
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          p = Path("build-coverage/coverage/summary.json")
          data = json.loads(p.read_text(encoding="utf-8"))
          line = data.get("line_percent", 0.0)
          branch = data.get("branch_percent", 0.0)
          func = data.get("function_percent", 0.0)
          with open(Path.home() / "coverage_summary.md", "w", encoding="utf-8") as f:
              f.write("## Coverage Metrics\n")
              f.write(f"- Line: **{line:.2f}%**\n")
              f.write(f"- Branch: **{branch:.2f}%**\n")
              f.write(f"- Function: **{func:.2f}%**\n")
          PY
          cat "$HOME/coverage_summary.md" >> "$GITHUB_STEP_SUMMARY"
